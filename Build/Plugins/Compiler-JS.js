"use strict";var _prototypeProperties=function(e,t,n){t&&Object.defineProperties(e,t),n&&Object.defineProperties(e.prototype,n)},_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},Promise=require("a-promise"),UglifyJS=null,Babel=null,Riot=null,ReactTools=null,FS=require("fs"),Path=require("path"),H=require("../H"),CompilerJS=function(){function e(){_classCallCheck(this,e)}return e.RegexAppend=/@(codekit-append|prepros-append|Compiler-Append)/,e.RegexOutput=/@Compiler-Output/,e.RegexCompiler=/@Compiler-Name/,e.RegexSourceMap=/@Compiler-Sourcemap/,e.RegexExtract=/".*"/,_prototypeProperties(e,{ExtractValue:{value:function(t){return new Promise(function(n,r){var o=e.RegexExtract.exec(t);return o.length?(o=o[0].substr(1,o[0].length-2),void n(o)):r()})},writable:!0,configurable:!0},ExtractPath:{value:function(t,n){return new Promise(function(r,o){e.ExtractValue(t).then(function(e){e.substr(0,1)!==Path.sep&&":"!==e.substr(1,1)&&(e=n+Path.sep+e),r(e)},o)})},writable:!0,configurable:!0},ParseAppend:{value:function(t,n){return new Promise(function(r,o){e.ExtractPath(t,n).then(function(e){FS.readFile(e,function(t,n){return t?o("The File '"+e+" doesn't exist, It was imported in "+FilePath+"'"):void r(n.toString())})},o)})},writable:!0,configurable:!0},ParseCompiler:{value:function(t){return new Promise(function(n,r){e.ExtractValue(t).then(function(e){e=e.toUpperCase(),"BABEL"===e?n("Babel"):"REACTTOOLS"===e?n("ReactTools"):"RIOT"===e?n("Riot"):""===e?n(null):n()},r)})},writable:!0,configurable:!0},Parse:{value:function(t,n,r){return new Promise(function(o,i){var a={Contents:"",Opts:r},u=Path.dirname(t),l=[];n.forEach(function(t,o){var i;-1!==t.indexOf("//")&&l.push(new Promise(function(a,l){return t=t.trim(),i=t.indexOf("//"),-1===i||0!==i?a():void(e.RegexAppend.test(t)?e.ParseAppend(t,u).then(function(e){n[o]=e,a()},l):e.RegexOutput.test(t)?e.ExtractPath(t,u).then(function(e){r.TargetFile=e,a()},l):e.RegexCompiler.test(t)?e.ParseCompiler(t).then(function(e){r.Compiler=e,a()},l):e.RegexSourceMap.test(t)?e.ExtractPath(t,u).then(function(e){r.SourceMap=""===e?null:e,a()}):a())}))}),Promise.all(l).then(function(){a.Contents=n.join("\n"),o(a)},i)})},writable:!0,configurable:!0},Process:{value:function(t,n){return new Promise(function(r,o){FS.readFile(t,function(i,a){return i?o(i):void e.Parse(t,a.toString().split("\n"),n).then(function(e){n=e.Opts;var t=null!==n.SourceMap,o={Content:"",SourceMap:"",Opts:n},i=null;"Babel"===n.Compiler?(Babel=Babel||require("babel"),i=Babel.transform(e.Contents,{sourceMap:t,playground:!0,experimental:!0}),o.Content=i.code,t&&(o.SourceMap=JSON.stringify(i.map))):"ReactTools"===n.Compiler?(ReactTools=ReactTools||require("react-tools"),i=ReactTools.transformWithDetails(e.Contents,{harmony:!0,stripTypes:!0,sourceMap:t}),o.Content=i.code,t&&(o.SourceMap=JSON.stringify(i.sourceMap))):"Riot"===n.Compiler&&(Riot=Riot||require("riot"),o.Content=Riot.compile(e.Contents,{compact:!0})),(n.Compiler||!n.SourceMap)&&n.SourceMap||"#!"===o.Content.substr(0,2)||(UglifyJS=UglifyJS||require("uglify-js"),i=UglifyJS.minify(o.Content||e.Content,{fromString:!0,outSourceMap:t?"js.map":void 0}),o.Content=i.code,t&&(o.SourceMap=i.map)),t&&(o.Content+="//# sourceMappingURL="+H.Relative(Path.dirname(n.TargetFile),n.SourceMap)),r(o)},o)})})},writable:!0,configurable:!0}}),e}();module.exports=CompilerJS;